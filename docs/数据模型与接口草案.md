今天吃什么（What to Eat）数据模型与接口草案 v0.1

一、实体与字段（关系型建议）
- User（用户）
  - id(uuid), wechat_unionid, wechat_openid, nickname, avatar_url, remark(爸爸/妈妈/儿子), phone(opt), created_at
- Organization（组织）
  - id(uuid), name, type(家庭/公司/团队), logo_url, theme, timezone, created_by(user_id), created_at
- Membership（成员关系）
  - id, org_id, user_id, role(admin/member), status(active/invited/removed), joined_at
- Category（分类）
  - id, org_id(null=全局), name, parent_id, order_index, tags(json)
- Dish（菜品）
  - id, org_id, name, category_id, tags(json), image_url, ingredients(json[]), condiments(json[]), steps(text[]), notes(text), difficulty, servings_suggest, status(on/off), creator_id, updated_at
  - ingredients/condiments item: {name, unit, quantity (number|range|string), alt_names(optional)}
- IngredientCatalog（食材字典，可选增强）
  - id, name, unit_default, type, synonyms(json[])
- MenuPlan（菜单计划/餐次）
  - id, org_id, date(date), meal(breakfast/lunch/dinner), cutoff_at, locked_at, created_by
- Selection（成员选择）
  - id, plan_id, org_id, user_id, dish_id, servings, note, created_at, updated_at
- Vote（点赞）
  - id, org_id, date, meal, dish_id, user_id, created_at
- Comment（评论）
  - id, org_id, plan_id, dish_id, user_id, content, created_at, status(normal/removed)
- ShoppingList（购物清单）
  - id, org_id, date_range(start,end), source_plans(json[]), items(json[]), generated_at
  - items item: {ingredient_name|id, quantity, unit, grouped_category, source_selection_ids(json[])}
- AuditLog（审计日志）
  - id, org_id, actor_user_id, action, target_type, target_id, detail(json), created_at

二、关键约束与索引
- 唯一性：Organization.name 唯一（平台级）；Membership(org_id,user_id) 唯一；Category(org_id,name,parent_id) 唯一。
- 外键：所有业务表绑定 org_id；Selection(plan_id,user_id,dish_id) 唯一（避免重复）。
- 索引：MenuPlan(org_id,date,meal)；Selection(plan_id,user_id)；Dish(org_id,category_id)；Vote(dish_id,date,meal)。
- 软删除：使用 status 字段或 deleted_at，保留历史可回溯。

三、接口草案（REST）
- Auth
  - GET /auth/wechat/callback?code=... → 创建/登录用户，返回会话与 token
  - GET /me → 当前用户信息与组织角色
- Organization
  - POST /orgs {name,type,timezone} → 创建组织
  - GET /orgs/:id → 组织详情
  - GET /orgs → 我加入的组织列表
  - PATCH /orgs/:id → 更新设置（logo, theme, cutoff 等）
  - POST /orgs/:id/invite → 生成邀请链接或发送邀请
  - POST /orgs/:id/members/:userId/role → 变更成员角色
- Category
  - GET /orgs/:id/categories → 列表（树形）
  - POST /orgs/:id/categories → 新增
  - PATCH /categories/:id → 编辑
  - DELETE /categories/:id → 删除（若有子类或菜品需校验）
  - GET /categories/default → 默认分类清单
- Dish
  - GET /orgs/:id/dishes?category=&q=&tags= → 搜索与筛选
  - POST /orgs/:id/dishes → 新增菜品
  - PATCH /dishes/:id → 编辑菜品
  - DELETE /dishes/:id → 下架/删除
  - POST /files/images → 图片上传（返回 image_url）
- MenuPlan / Selection
  - POST /orgs/:id/plans {date,meal,cutoff_at} → 创建餐次（可批量生成7天）
  - GET /orgs/:id/plans?start=&end= → 查询计划
  - POST /plans/:id/lock → 锁定餐次（生成购物清单）
  - POST /plans/:id/selections → 新增选择 {dish_id,servings,note}
  - PATCH /selections/:id → 编辑（截止前）
  - DELETE /selections/:id → 移除（截止前）
- Vote & Comment
  - POST /dishes/:id/votes → 点赞
  - DELETE /dishes/:id/votes → 取消点赞
  - POST /plans/:id/comments → 评论
  - GET /plans/:id/comments → 列表；管理员可删除
- Shopping
  - GET /orgs/:id/shopping?date=&meal= → 单餐次购物清单
  - GET /orgs/:id/shopping?start=&end= → 多日聚合购物清单
  - POST /shopping/:id/recalculate → 重新计算（管理员）
- History & Export
  - GET /orgs/:id/history?start=&end=&user=&dish= → 查询历史
  - GET /orgs/:id/export?type=csv|xlsx → 导出
- Notification
  - POST /orgs/:id/notifications/test → 模板消息测试发送

四、计算与算法（购物清单）
- 聚合流程：加载锁定计划 → 汇总 Selection → 展开 Dish.ingredients → 同名合并。
- 单位换算：维护单位映射表（kg↔g、l↔ml）；优先统一到组织偏好单位。
- 适量与非结构化：标记“人工校正”，支持管理端输入默认值；二次计算缓存。
- 分组与排序：按品类分组（蔬菜/肉类/主食等）、常购路径排序（可配置）。

五、通知与集成
- 微信模板消息：
  - 截止前提醒（餐次、剩余时间、点击进入选择页链接）
  - 锁定通知（管理员收到购物清单链接）
  - 解锁/重算通知（影响范围提示）
- 站内与邮件（可选）：同消息结构，便于多渠道覆盖。

六、权限矩阵（简要）
- 成员：查看与选择餐次、点赞评论、查看购物清单（只读）、查看历史。
- 管理员：组织配置、分类与菜品管理、设置餐次与截止时间、解锁与重算、导出报表、成员管理。
- 系统管理员：平台级运维、风控与审核（后续）。

七、错误码与边界（示例）
- 400_INVALID_INPUT：字段校验失败，例如单位不合法。
- 403_FORBIDDEN：无权限操作，例如非管理员解锁。
- 409_CONFLICT：截止后修改冲突；选择重复。
- 422_UNPROCESSABLE：“适量”无法自动合并，需人工校正。
- 500_INTERNAL：服务异常，返回追踪 id。

八、非功能需求
- 性能：主要接口 P95 < 300ms；购物清单重算可异步并缓存结果。
- 安全：JWT + CSRF 防护；输入过滤；对象存储直传签名。
- 审计：敏感操作（锁定/解锁/删除）记录 AuditLog；定期备份。